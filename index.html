<!DOCTYPE html>
<html>
  <head>
    <title>Daylight Saving Time</title>
    <meta charset="utf-8">
    <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic' rel='stylesheet' type='text/css'>
    <style>

    body {
      font-size: 12px;
      font-family: "Lato", Helvetica, Arial, Verdana, sans-serif;
    }

    a {
      text-decoration: none;
      color: steelblue;
    }

    a:hover {
      text-decoration: underline;
    }

    div.clear {
      clear: both;
    }

    div.container {
      width: 800px;
      margin-left: auto;
      margin-right: auto;
    }

    div.header {
      font-weight: bold;
      font-size: 28px;
    }

    div.subheader {
      padding-bottom: 8px;
      font-size: 14px;
    }

    g.sun path {
      stroke: #fadd6b;
      stroke-width: 2px;
    }

    rect.sun {
      stroke: none;
    }

    g.sun path, rect.sun, path.with {
      fill: #fadd6b;
    }

    path.without {
      fill: tomato;
      stroke: black;
      stroke-width: 2px;
    }

    g.night rect, rect.night {
      stroke: none;
      fill: #666;
    }

    g.awake rect, rect.awake {
      opacity: 0.5;
      stroke: none;
      fill: #fff;
    }

    g.work rect, rect.work {
      opacity: 0.55;
      stroke: none;
      fill: tomato;
    }

    g.labels text {
      text-anchor: middle;
      fill: #fff;
      font-size: 12px;
    }

    g.labels path {
      stroke-width: 1px;
      stroke: #fff;
      fill: none;
    }

    g.hours path {
      stroke-width: 1px;
      stroke: #fff;
      opacity: 0.4;
      fill: none;
      stroke-dasharray: 2,2;
    }

    g.hours text {
      text-anchor: end;
      fill: #000;
      font-size: 11px;
    }

    g.legend text {
      fill: #fff;
      font-size: 12px;
      text-anchor: start;
    }

    div.compare-header {
      text-align: center;
      margin: 12px 0px 6px 0px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 6px;
      font-size: 22px;
      font-weight: bold;
    }

    div.compare-header div.dates {
      font-size: 14px;
      font-weight: normal;
    }

    div.compare div.with, div.compare div.without {
      width: 50%;
      float: left;
      text-align: center;
    }

    div.compare div.compare-subheader {
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      color: #444;
      padding-bottom: 4px;
    }

    div.compare div.caption {
      text-transform: uppercase;
      font-size: 14px;
      color: #444;
      font-weight: bold;
    }

    div.compare-row {
      padding-bottom: 12px;
      margin-bottom: 6px;
      border-bottom: 1px solid #ccc;
    }

    div.compare-row:last-of-type {
      border-bottom: none;
    }

    div.compare div.datum {
      font-size: 20px;
      color: tomato;
    }

    div.form {
      font-weight: bold;
      margin-bottom: 4px;
    }

    span.latlng,span.timezone {
      font-style: italic;
      font-weight: normal;
    }

    span.latlng {
      margin-left: 6px;
    }

    span.to {
      margin: 0px 4px;
      font-weight: normal;
    }

    div.form:first-of-type {
      margin-top: 12px;
    }

    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">Effects of Daylight Saving Time</div>
      <div class="subheader">By <a href="http://noahveltman.com/twitter">Noah Veltman</a></div>
      <div class="subheader">Showing the effect of Daylight Saving Time on actual daylight experienced.</div>
      <div class="subheader">Data is from 2013, sunrises/sunsets are from the <a href="http://aa.usno.navy.mil/data/docs/RS_OneYear.php">US Naval Observatory</a>.</div>
      <div class="subheader"><strong>Caveats:</strong> Doesn't account for the fact that sunrise and sunset are gradual events, with durations that vary by season and latitude. Also not configured to allow for working the night shift or weird time entries, like being asleep but at work.</div>
      <div class="form">
        City&nbsp;<select id="city">
          <option selected>New York, NY</option>
          <option>Los Angeles, CA</option>
          <option>San Francisco, CA</option>
          <option>Seattle, WA</option>
          <option>Chicago, IL</option>
          <option>Washington, DC</option>
          <option>Miami, FL</option>
          <option>Portland, OR</option>
          <option>Las Vegas, NV</option>
          <option>Denver, CO</option>
          <option>Houston, TX</option>
          <option>Dallas, TX</option>
          <option>New Orleans, LA</option>
          <option>Boston, MA</option>
          <option>Philadelphia, PA</option>
          <option>Atlanta, GA</option>
          <option>Nashville, TN</option>
          <option>Cleveland, OH</option>
          <option>Charlotte, NC</option>
          <option>Detroit, MI</option>
          <option>Salt Lake City, UT</option>
        </select>
        <span class="latlng"></span>&nbsp;&nbsp;<span class="timezone"></span>
      </div>
      <div class="form">
        <div class="awake">
        Awake from&nbsp;</span><select class="time" id="awake-times-0">
          <option value="0:00">12:00am</option><option value="0:15">12:15am</option><option value="0:30">12:30am</option><option value="0:45">12:45am</option><option value="1:00">1:00am</option><option value="1:15">1:15am</option><option value="1:30">1:30am</option><option value="1:45">1:45am</option><option value="2:00">2:00am</option><option value="2:15">2:15am</option><option value="2:30">2:30am</option><option value="2:45">2:45am</option><option value="3:00">3:00am</option><option value="3:15">3:15am</option><option value="3:30">3:30am</option><option value="3:45">3:45am</option><option value="4:00">4:00am</option><option value="4:15">4:15am</option><option value="4:30">4:30am</option><option value="4:45">4:45am</option><option value="5:00">5:00am</option><option value="5:15">5:15am</option><option value="5:30">5:30am</option><option value="5:45">5:45am</option><option value="6:00">6:00am</option><option value="6:15">6:15am</option><option value="6:30">6:30am</option><option value="6:45">6:45am</option><option value="7:00" selected>7:00am</option><option value="7:15">7:15am</option><option value="7:30">7:30am</option><option value="7:45">7:45am</option><option value="8:00">8:00am</option><option value="8:15">8:15am</option><option value="8:30">8:30am</option><option value="8:45">8:45am</option><option value="9:00">9:00am</option><option value="9:15">9:15am</option><option value="9:30">9:30am</option><option value="9:45">9:45am</option><option value="10:00">10:00am</option><option value="10:15">10:15am</option><option value="10:30">10:30am</option><option value="10:45">10:45am</option><option value="11:00">11:00am</option><option value="11:15">11:15am</option><option value="11:30">11:30am</option><option value="11:45">11:45am</option><option value="12:00">12:00pm</option><option value="12:15">12:15pm</option><option value="12:30">12:30pm</option><option value="12:45">12:45pm</option><option value="13:00">1:00pm</option><option value="13:15">1:15pm</option><option value="13:30">1:30pm</option><option value="13:45">1:45pm</option><option value="14:00">2:00pm</option><option value="14:15">2:15pm</option><option value="14:30">2:30pm</option><option value="14:45">2:45pm</option><option value="15:00">3:00pm</option><option value="15:15">3:15pm</option><option value="15:30">3:30pm</option><option value="15:45">3:45pm</option><option value="16:00">4:00pm</option><option value="16:15">4:15pm</option><option value="16:30">4:30pm</option><option value="16:45">4:45pm</option><option value="17:00">5:00pm</option><option value="17:15">5:15pm</option><option value="17:30">5:30pm</option><option value="17:45">5:45pm</option><option value="18:00">6:00pm</option><option value="18:15">6:15pm</option><option value="18:30">6:30pm</option><option value="18:45">6:45pm</option><option value="19:00">7:00pm</option><option value="19:15">7:15pm</option><option value="19:30">7:30pm</option><option value="19:45">7:45pm</option><option value="20:00">8:00pm</option><option value="20:15">8:15pm</option><option value="20:30">8:30pm</option><option value="20:45">8:45pm</option><option value="21:00">9:00pm</option><option value="21:15">9:15pm</option><option value="21:30">9:30pm</option><option value="21:45">9:45pm</option><option value="22:00">10:00pm</option><option value="22:15">10:15pm</option><option value="22:30">10:30pm</option><option value="22:45">10:45pm</option><option value="23:00">11:00pm</option><option value="23:15">11:15pm</option><option value="23:30">11:30pm</option><option value="23:45">11:45pm</option><option value="24:00">12:00am</option>
        </select><span class="to">to</span><select class="time" id="awake-times-1">
          <option value="0:00">12:00am</option><option value="0:15">12:15am</option><option value="0:30">12:30am</option><option value="0:45">12:45am</option><option value="1:00">1:00am</option><option value="1:15">1:15am</option><option value="1:30">1:30am</option><option value="1:45">1:45am</option><option value="2:00">2:00am</option><option value="2:15">2:15am</option><option value="2:30">2:30am</option><option value="2:45">2:45am</option><option value="3:00">3:00am</option><option value="3:15">3:15am</option><option value="3:30">3:30am</option><option value="3:45">3:45am</option><option value="4:00">4:00am</option><option value="4:15">4:15am</option><option value="4:30">4:30am</option><option value="4:45">4:45am</option><option value="5:00">5:00am</option><option value="5:15">5:15am</option><option value="5:30">5:30am</option><option value="5:45">5:45am</option><option value="6:00">6:00am</option><option value="6:15">6:15am</option><option value="6:30">6:30am</option><option value="6:45">6:45am</option><option value="7:00">7:00am</option><option value="7:15">7:15am</option><option value="7:30">7:30am</option><option value="7:45">7:45am</option><option value="8:00">8:00am</option><option value="8:15">8:15am</option><option value="8:30">8:30am</option><option value="8:45">8:45am</option><option value="9:00">9:00am</option><option value="9:15">9:15am</option><option value="9:30">9:30am</option><option value="9:45">9:45am</option><option value="10:00">10:00am</option><option value="10:15">10:15am</option><option value="10:30">10:30am</option><option value="10:45">10:45am</option><option value="11:00">11:00am</option><option value="11:15">11:15am</option><option value="11:30">11:30am</option><option value="11:45">11:45am</option><option value="12:00">12:00pm</option><option value="12:15">12:15pm</option><option value="12:30">12:30pm</option><option value="12:45">12:45pm</option><option value="13:00">1:00pm</option><option value="13:15">1:15pm</option><option value="13:30">1:30pm</option><option value="13:45">1:45pm</option><option value="14:00">2:00pm</option><option value="14:15">2:15pm</option><option value="14:30">2:30pm</option><option value="14:45">2:45pm</option><option value="15:00">3:00pm</option><option value="15:15">3:15pm</option><option value="15:30">3:30pm</option><option value="15:45">3:45pm</option><option value="16:00">4:00pm</option><option value="16:15">4:15pm</option><option value="16:30">4:30pm</option><option value="16:45">4:45pm</option><option value="17:00">5:00pm</option><option value="17:15">5:15pm</option><option value="17:30">5:30pm</option><option value="17:45">5:45pm</option><option value="18:00">6:00pm</option><option value="18:15">6:15pm</option><option value="18:30">6:30pm</option><option value="18:45">6:45pm</option><option value="19:00">7:00pm</option><option value="19:15">7:15pm</option><option value="19:30">7:30pm</option><option value="19:45">7:45pm</option><option value="20:00">8:00pm</option><option value="20:15">8:15pm</option><option value="20:30">8:30pm</option><option value="20:45">8:45pm</option><option value="21:00">9:00pm</option><option value="21:15">9:15pm</option><option value="21:30">9:30pm</option><option value="21:45">9:45pm</option><option value="22:00">10:00pm</option><option value="22:15">10:15pm</option><option value="22:30">10:30pm</option><option value="22:45">10:45pm</option><option value="23:00" selected>11:00pm</option><option value="23:15">11:15pm</option><option value="23:30">11:30pm</option><option value="23:45">11:45pm</option><option value="24:00">12:00am</option>
        </select>
       </div>
        <div class="work">
        Working from&nbsp;<select class="time" id="work-times-0">
          <option value="0:00">12:00am</option><option value="0:15">12:15am</option><option value="0:30">12:30am</option><option value="0:45">12:45am</option><option value="1:00">1:00am</option><option value="1:15">1:15am</option><option value="1:30">1:30am</option><option value="1:45">1:45am</option><option value="2:00">2:00am</option><option value="2:15">2:15am</option><option value="2:30">2:30am</option><option value="2:45">2:45am</option><option value="3:00">3:00am</option><option value="3:15">3:15am</option><option value="3:30">3:30am</option><option value="3:45">3:45am</option><option value="4:00">4:00am</option><option value="4:15">4:15am</option><option value="4:30">4:30am</option><option value="4:45">4:45am</option><option value="5:00">5:00am</option><option value="5:15">5:15am</option><option value="5:30">5:30am</option><option value="5:45">5:45am</option><option value="6:00">6:00am</option><option value="6:15">6:15am</option><option value="6:30">6:30am</option><option value="6:45">6:45am</option><option value="7:00">7:00am</option><option value="7:15">7:15am</option><option value="7:30">7:30am</option><option value="7:45">7:45am</option><option value="8:00">8:00am</option><option value="8:15">8:15am</option><option value="8:30">8:30am</option><option value="8:45">8:45am</option><option value="9:00" selected>9:00am</option><option value="9:15">9:15am</option><option value="9:30">9:30am</option><option value="9:45">9:45am</option><option value="10:00">10:00am</option><option value="10:15">10:15am</option><option value="10:30">10:30am</option><option value="10:45">10:45am</option><option value="11:00">11:00am</option><option value="11:15">11:15am</option><option value="11:30">11:30am</option><option value="11:45">11:45am</option><option value="12:00">12:00pm</option><option value="12:15">12:15pm</option><option value="12:30">12:30pm</option><option value="12:45">12:45pm</option><option value="13:00">1:00pm</option><option value="13:15">1:15pm</option><option value="13:30">1:30pm</option><option value="13:45">1:45pm</option><option value="14:00">2:00pm</option><option value="14:15">2:15pm</option><option value="14:30">2:30pm</option><option value="14:45">2:45pm</option><option value="15:00">3:00pm</option><option value="15:15">3:15pm</option><option value="15:30">3:30pm</option><option value="15:45">3:45pm</option><option value="16:00">4:00pm</option><option value="16:15">4:15pm</option><option value="16:30">4:30pm</option><option value="16:45">4:45pm</option><option value="17:00">5:00pm</option><option value="17:15">5:15pm</option><option value="17:30">5:30pm</option><option value="17:45">5:45pm</option><option value="18:00">6:00pm</option><option value="18:15">6:15pm</option><option value="18:30">6:30pm</option><option value="18:45">6:45pm</option><option value="19:00">7:00pm</option><option value="19:15">7:15pm</option><option value="19:30">7:30pm</option><option value="19:45">7:45pm</option><option value="20:00">8:00pm</option><option value="20:15">8:15pm</option><option value="20:30">8:30pm</option><option value="20:45">8:45pm</option><option value="21:00">9:00pm</option><option value="21:15">9:15pm</option><option value="21:30">9:30pm</option><option value="21:45">9:45pm</option><option value="22:00">10:00pm</option><option value="22:15">10:15pm</option><option value="22:30">10:30pm</option><option value="22:45">10:45pm</option><option value="23:00">11:00pm</option><option value="23:15">11:15pm</option><option value="23:30">11:30pm</option><option value="23:45">11:45pm</option><option value="24:00">12:00am</option>
        </select><span class="to">to</span><select class="time" id="work-times-1">
          <option value="0:00">12:00am</option><option value="0:15">12:15am</option><option value="0:30">12:30am</option><option value="0:45">12:45am</option><option value="1:00">1:00am</option><option value="1:15">1:15am</option><option value="1:30">1:30am</option><option value="1:45">1:45am</option><option value="2:00">2:00am</option><option value="2:15">2:15am</option><option value="2:30">2:30am</option><option value="2:45">2:45am</option><option value="3:00">3:00am</option><option value="3:15">3:15am</option><option value="3:30">3:30am</option><option value="3:45">3:45am</option><option value="4:00">4:00am</option><option value="4:15">4:15am</option><option value="4:30">4:30am</option><option value="4:45">4:45am</option><option value="5:00">5:00am</option><option value="5:15">5:15am</option><option value="5:30">5:30am</option><option value="5:45">5:45am</option><option value="6:00">6:00am</option><option value="6:15">6:15am</option><option value="6:30">6:30am</option><option value="6:45">6:45am</option><option value="7:00">7:00am</option><option value="7:15">7:15am</option><option value="7:30">7:30am</option><option value="7:45">7:45am</option><option value="8:00">8:00am</option><option value="8:15">8:15am</option><option value="8:30">8:30am</option><option value="8:45">8:45am</option><option value="9:00">9:00am</option><option value="9:15">9:15am</option><option value="9:30">9:30am</option><option value="9:45">9:45am</option><option value="10:00">10:00am</option><option value="10:15">10:15am</option><option value="10:30">10:30am</option><option value="10:45">10:45am</option><option value="11:00">11:00am</option><option value="11:15">11:15am</option><option value="11:30">11:30am</option><option value="11:45">11:45am</option><option value="12:00">12:00pm</option><option value="12:15">12:15pm</option><option value="12:30">12:30pm</option><option value="12:45">12:45pm</option><option value="13:00">1:00pm</option><option value="13:15">1:15pm</option><option value="13:30">1:30pm</option><option value="13:45">1:45pm</option><option value="14:00">2:00pm</option><option value="14:15">2:15pm</option><option value="14:30">2:30pm</option><option value="14:45">2:45pm</option><option value="15:00">3:00pm</option><option value="15:15">3:15pm</option><option value="15:30">3:30pm</option><option value="15:45">3:45pm</option><option value="16:00">4:00pm</option><option value="16:15">4:15pm</option><option value="16:30">4:30pm</option><option value="16:45">4:45pm</option><option value="17:00">5:00pm</option><option value="17:15">5:15pm</option><option value="17:30">5:30pm</option><option value="17:45">5:45pm</option><option value="18:00" selected>6:00pm</option><option value="18:15">6:15pm</option><option value="18:30">6:30pm</option><option value="18:45">6:45pm</option><option value="19:00">7:00pm</option><option value="19:15">7:15pm</option><option value="19:30">7:30pm</option><option value="19:45">7:45pm</option><option value="20:00">8:00pm</option><option value="20:15">8:15pm</option><option value="20:30">8:30pm</option><option value="20:45">8:45pm</option><option value="21:00">9:00pm</option><option value="21:15">9:15pm</option><option value="21:30">9:30pm</option><option value="21:45">9:45pm</option><option value="22:00">10:00pm</option><option value="22:15">10:15pm</option><option value="22:30">10:30pm</option><option value="22:45">10:45pm</option><option value="23:00">11:00pm</option><option value="23:15">11:15pm</option><option value="23:30">11:30pm</option><option value="23:45">11:45pm</option><option value="24:00">12:00am</option>
        </select>
       </div>

      </div>
      <div class="chart"></div>
      <div class="compare">
        <div class="compare-header">
          <div>With DST vs. Without</div>
          <div class="dates">March 10, 2013 - November 2, 2013</div>
        </div>
        <div class="compare-row" id="avg-hours">
          <div class="compare-subheader">Avg. hours of daylight</div>
          <div class="with"></div>
          <div class="without"></div>
          <div class="clear"></div>
        </div>
        <div class="compare-row" id="free-hours">
          <div class="compare-subheader">Avg. free hours of daylight (awake, not at work)</div>
          <div class="with"></div>
          <div class="without"></div>
          <div class="clear"></div>
        </div>
        <div class="compare-row" id="wake-up">
          <div class="compare-subheader">Days it's light when you wake up</div>
          <div class="with"></div>
          <div class="without"></div>
          <div class="clear"></div>
        </div>
        <div class="compare-row" id="leave-work">
          <div class="compare-subheader">Days it's light when you leave work</div>
          <div class="with"></div>
          <div class="without"></div>
          <div class="clear"></div>
        </div>

    </div>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script>

      var mainChart = d3.select("div.chart");

      var margin = {top: 4, right: 20, bottom: 20, left: 20};
      var w = Math.min(Math.max(window.innerWidth-40,400),800) - margin.right - margin.left, h = 250 - margin.bottom - margin.top;

      d3.select("div.container").style("width",w+"px");

      var svg = mainChart.append("svg")
                  .attr("width",w+margin.left+margin.right)
                  .attr("height",h+margin.top+margin.bottom)
                  .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      var x = d3.scale.linear().domain([0,364]).range([0,w]);
      var y = d3.scale.linear().domain([0,24]).range([0,h]);

      var line = d3.svg.line()
                  .interpolate("basis")
                  .x(function(d,i) {

                    i = (i > 364) ? 729 - i : i;
                    return x(i > 364 ? 365 - (i - 364) : i); 
                  })
                  .y(function(d,i) {
                    return y(d);
                  });

      var workTimes = ["09:00","18:00"], awakeTimes = ["07:00","23:00"], city = "New York, NY", data;

      svg.append("g")
        .attr("class","night")
          .append("rect")
          .attr("width",w)
          .attr("height",h)
          .attr("x",0)
          .attr("y",0)
          .attr("class","night");

      //Do labels here
      var labels = svg.append("g")
        .attr("class","labels")
        .selectAll("g")
        .data(["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"])
        .enter()
          .append("g");

      labels.append("text")
        .text(function(d){
          return d;
        })
        .attr("x",function(d,i){
          return (w/24)+(i*w/12);
        })
        .attr("y",12);

      labels.filter(function(d,i){
        return i < 11;
      })
        .append("path")
          .attr("d",function(d,i){
            i++;
            return "M"+(w*i/12)+",0 L"+(w*i/12)+","+h;
          });

      var hours = svg.append("g")
        .attr("class","hours")
        .selectAll("g")
        .data([0,6,12,18,24])
        .enter()
          .append("g");

      hours.append("text")
        .text(function(d){
          if (d == 12) return "12p";
          if (!d || d == 24) return "12a";
          return (d%12)+(d < 12 ? "a" : "p");
        })
        .attr("x",0)
        .attr("dx","-0.25em")
        .attr("dy",function(d,i){
          if (!d) return "1em";
          if (d == 24) return 0;
          return "0.4em";
        })
        .attr("y",function(d,i){
          return h*i/4;
        });

      var sun = svg.append("g")
                  .attr("class","sun");

      var awake = svg.append("g")
                    .attr("class","awake");

      var latlng = d3.select("span.latlng");

      var timezone = d3.select("span.timezone");

      var work = svg.append("g")
                    .attr("class","work");

      svg.append("rect")
        .attr("class","night")
        .attr("width",w)
        .attr("height",margin.bottom)
        .attr("x",0)
        .attr("y",h);

      var legend = svg.append("g")
                    .attr("class","legend")
                    .attr("transform", "translate(" + ((w-200)/2) + ")");

      //Bespoke repetitive legend placement code!
      legend.append("rect")
        .attr("class","sun")
        .attr("x",4)
        .attr("y",h+4)
        .attr("width",12)
        .attr("height",12);

      legend.append("text")
        .text("Daylight")
        .attr("y",h+4)
        .attr("dy","10px")
        .attr("x",20);

      legend.append("rect")
        .attr("class","awake")
        .attr("x",74)
        .attr("y",h+4)
        .attr("width",12)
        .attr("height",12);

      legend.append("text")
        .text("Asleep")
        .attr("y",h+4)
        .attr("dy","10px")
        .attr("x",90);

      legend.append("rect")
        .attr("class","sun")
        .attr("x",134)
        .attr("y",h+4)
        .attr("width",12)
        .attr("height",12);

      legend.append("rect")
        .attr("class","work")
        .attr("x",134)
        .attr("y",h+4)
        .attr("width",12)
        .attr("height",12);

      legend.append("text")
        .text("At Work")
        .attr("y",h+4)
        .attr("dy","10px")
        .attr("x",150);

      var withWithout = d3.selectAll("div.with,div.without");
      
      withWithout.append("div")
        .attr("class","caption")
        .text(function(d,i){
          if (i % 2) return "Without";
          return "With";
        });

      var datumDivs = withWithout.append("div")
        .attr("class","datum")
        

      datumDivs.append("span")
        .attr("class","datum");

      datumDivs.append("span")
        .attr("class","difference");

      var drawSunsets = function() {
        d3.json("cities/"+city.split(",")[0].replace(" ","_")+".json",function(err,j){
          data = j;

          data.sun = data.sun.map(function(d,i){
            return d.map(function(f){
             
              return parseTime(f,i >= 68 && i < 306);

            });
          });

          data.summer = {
            "with": data.sun.slice(68,306)
          };

          data.summer.without = data.summer.with.map(function(d){
            return d.map(function(f){
              return f-1;
            });
          });

          latlng.text(Math.abs(data.lat)+(data.lat < 0 ? "S" : "N")+", "+Math.abs(data.lng)+(data.lng < 0 ? "E" : "W"));

          timezone.text("("+data.timezone+")");

          sun.selectAll("path")
            .data([data.sun])
            .enter()
            .append("path");

          updateSun();

          awake.selectAll("rect")
            .data([["0:00",awakeTimes[0]],[awakeTimes[1],"24:00"]])
            .enter()
            .append("rect");

          updateAwake();

          work.selectAll("rect")
            .data([workTimes])
            .enter()
            .append("rect");

          updateWork();

          updateComparisons();

        });
      };

      d3.select("select#city").on("change",function(){
        city = this.value;
        drawSunsets();
      });

      d3.selectAll("div.awake select").on("change",function(){
        
        var id = parseInt(this.id.split("-")[2]);
        
        console.log(id);

        awakeTimes[id] = this.value;

        awake.selectAll("rect")
          .data([["0:00",awakeTimes[0]],[awakeTimes[1],"24:00"]])

        if (parseTime(awakeTimes[1]) < parseTime(awakeTimes[0])) awakeTimes[1] = "24:00";
        updateAwake();
      });

      d3.selectAll("div.work select").on("change",function(){
        
        var id = parseInt(this.id.split("-")[2]);

        workTimes[id] = this.value;

        if (parseTime(workTimes[1]) < parseTime(workTimes[0])) workTimes[1] = "24:00";
        updateWork();
      });

      drawSunsets();

      function parseTime(t,dst) {

        return d3.sum(t.split(":").map(function(d,i){
          return parseInt(d)/(i ? 60 : 1);
        }))+(dst ? 1 : 0);
      }

      function updateSun() {
        sun.select("path")
          .attr("d",function(d){
            rises = d.map(function(f){
              return f[0];
            });

            sets = d.map(function(f){
              return f[1];
            });
            
            sets.reverse();

            var all = rises.concat(sets);

            return line(all);

          });
      }

      function updateAwake() {
        awake.selectAll("rect")
          .attr("x",0)
          .attr("width",w)
          .attr("y",function(d){
            return y(parseTime(d[0]));
          })
          .attr("height",function(d){
            return y(parseTime(d[1])) - y(parseTime(d[0]));
          });

        updateComparisons();
      }

      function updateWork() {
        work.selectAll("rect")
          .attr("x",0)
          .attr("width",w)
          .attr("y",function(d){
            return y(parseTime(d[0]));
          })
          .attr("height",function(d){
            return y(parseTime(d[1])) - y(parseTime(d[0]));
          });

        updateComparisons();
      }

      var compareData = {
        "with": {
          "avg-hours": d3.select("div#avg-hours div.with div.datum"),
          "free-hours": d3.select("div#free-hours div.with div.datum"),
          "wake-up": d3.select("div#wake-up div.with div.datum"),
          "leave-work": d3.select("div#leave-work div.with div.datum")
        },
        "without": {
          "avg-hours": d3.select("div#avg-hours div.without div.datum"),
          "free-hours": d3.select("div#free-hours div.without div.datum"),
          "wake-up": d3.select("div#wake-up div.without div.datum"),
          "leave-work": d3.select("div#leave-work div.without div.datum")
        }
      }

      function updateComparisons() {
        for (var stub in compareData.with) {
          updateCalc(stub);
        }
      }

      function updateCalc(stub) {

        var datum = {
          "with": null,
          "without": null
        };

        var processor;

        switch (stub) {
          case "avg-hours":
          case "free-hours":

            var a = [parseTime(awakeTimes[0]),parseTime(awakeTimes[1])];

            if (stub == "avg-hours") {

              processor = function(d){

                var bottom = Math.max(a[0],d[0]);
                var top = Math.min(a[1],d[1]);

                return top-bottom;
              };

            } else {

              var w = [parseTime(workTimes[0]),parseTime(workTimes[1])];

              processor = function(d){

                var am = w[0] - Math.max(a[0],d[0]);
                var pm = Math.min(a[1],d[1]) - w[1];

                return am+pm;
              };

            }

            datum.with = Math.round(d3.mean(data.summer.with,processor)*100)/100;
            datum.without = Math.round(d3.mean(data.summer.without,processor)*100)/100;

            compareData.without[stub].select("span.difference").text("");
            compareData.with[stub].select("span.difference").text("");
            
            if (datum.with > datum.without) {
              compareData.with[stub].select("span.difference").text(" (+"+Math.round((datum.with-datum.without)*100)/100+")")
            } else if (datum.without > datum.with) {
              compareData.without[stub].select("span.difference").text(" (+"+Math.round((datum.without-datum.with)*100)/100+")")
            }

            datum.with = datum.with+" hrs";
            datum.without = datum.without+" hrs";

            break;
          case "wake-up":
          case "leave-work":

            if (stub == "wake-up") {

              var a = parseTime(awakeTimes[0]);

              processor = function(d){

                return d[0] < a;

              };

            } else {

            var w = parseTime(workTimes[1]);

              processor = function(d){

                return w < d[1];

              };


            }

            datum.with = data.summer.with.filter(processor).length;
            datum.without = data.summer.without.filter(processor).length;

            compareData.without[stub].select("span.difference").text("");
            compareData.with[stub].select("span.difference").text("");
            
            if (datum.with > datum.without) {
              compareData.with[stub].select("span.difference").text(" (+"+(datum.with-datum.without)+")")
            } else if (datum.without > datum.with) {
              compareData.without[stub].select("span.difference").text(" (+"+(datum.without-datum.with)+")")
            }

            datum.with = datum.with+" days";
            datum.without = datum.without+" days";


        }

        compareData.with[stub].select("span.datum").text(datum.with);
        compareData.without[stub].select("span.datum").text(datum.without);

      }

    </script>
  </body>
</html>
